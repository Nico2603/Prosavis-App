rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // === FUNCIONES HELPER ===
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwnerId(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    function isServiceOwner(serviceId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/services/$(serviceId))
        && request.auth.uid == get(/databases/$(database)/documents/services/$(serviceId)).data.providerId;
    }
    function validStorageUrl(url) {
      return url == null || url.matches('https://(firebasestorage|storage)\\.googleapis\\.com/.*');
    }
    
    // Helper para validar lista de imágenes (hasta 4) sea lista de strings
    function listAllStringsMax4(l) {
      return l == null || (
        l is list && l.size() <= 4 &&
        (l.size() == 0 || l[0] is string) &&
        (l.size() < 2 || l[1] is string) &&
        (l.size() < 3 || l[2] is string) &&
        (l.size() < 4 || l[3] is string)
      );
    }
    
    // Helper para validar que rating sea entero
    function isInt(n) { 
      return n is number && n == int(n); 
    }
    
    // Helper para validar timestamps cercanos al momento actual
    function nearNow(ts) {
      return ts is timestamp
             && (request.time - ts <= duration.value(5, 'minutes'))
             && (ts - request.time <= duration.value(1, 'minutes'));
    }
    
    // === USUARIOS ===
    match /users/{userId} {
      allow read: if isOwnerId(userId);

      // Crear/actualizar usuario (compatible con código actual)
      allow create, update: if isOwnerId(userId)
        && request.resource.id == request.auth.uid
        && (!request.resource.data.keys().hasAny(['photoUrl']) || request.resource.data.photoUrl == null
            || request.resource.data.photoUrl.matches('https://(firebasestorage|storage)\\.googleapis\\.com/.*|https://(lh3|lh4|lh5|lh6)\\.googleusercontent\\.com/.*|https://yt3\\.ggpht\\.com/.*'));

      allow delete: if isOwnerId(userId);
    }

    // === SERVICIOS ===
    match /services/{serviceId} {
      allow read: if true;

      // Crear servicio con whitelisting completo y validaciones mejoradas
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.providerId
        && request.resource.data.keys().hasAll(['title','description','category','price','providerId'])
        && request.resource.data.keys().hasOnly(['title','description','category','price','providerId','mainImage','images','createdAt','updatedAt'])
        && request.resource.data.title is string && request.resource.data.title.size() > 5 && request.resource.data.title.size() <= 120
        && request.resource.data.description is string && request.resource.data.description.size() > 10 && request.resource.data.description.size() <= 5000
        && request.resource.data.category is string && request.resource.data.category.size() > 0
        && request.resource.data.price is number && request.resource.data.price >= 0
        && (!request.resource.data.keys().hasAny(['mainImage']) || validStorageUrl(request.resource.data.mainImage))
        && listAllStringsMax4(request.resource.data.images)
        && (!request.resource.data.keys().hasAny(['createdAt']) || nearNow(request.resource.data.createdAt))
        && (!request.resource.data.keys().hasAny(['updatedAt']) || nearNow(request.resource.data.updatedAt));

      // Actualizar servicio con validaciones mejoradas
      allow update: if isSignedIn()
        && request.auth.uid == resource.data.providerId
        && request.resource.data.providerId == resource.data.providerId
        && (!request.resource.data.keys().hasAny(['mainImage']) || validStorageUrl(request.resource.data.mainImage))
        && (!request.resource.data.keys().hasAny(['price']) || (request.resource.data.price is number && request.resource.data.price >= 0))
        && (!request.resource.data.keys().hasAny(['images']) || listAllStringsMax4(request.resource.data.images))
        && (!request.resource.data.keys().hasAny(['title']) || (request.resource.data.title is string && request.resource.data.title.size() > 5 && request.resource.data.title.size() <= 120))
        && (!request.resource.data.keys().hasAny(['description']) || (request.resource.data.description is string && request.resource.data.description.size() > 10 && request.resource.data.description.size() <= 5000))
        && (!request.resource.data.keys().hasAny(['category']) || (request.resource.data.category is string && request.resource.data.category.size() > 0))
        && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(['title','description','category','price','mainImage','images','updatedAt'])
        && (!request.resource.data.keys().hasAny(['updatedAt']) || (
             request.resource.data.updatedAt is timestamp
             && request.resource.data.updatedAt >= resource.data.updatedAt
             && nearNow(request.resource.data.updatedAt)
           ));

      allow delete: if isSignedIn() && request.auth.uid == resource.data.providerId;

      // === RESEÑAS ===
      match /reviews/{reviewId} {
        allow read: if true;

        // Fuerza un solo review por usuario: id del doc == uid
        allow create: if isSignedIn()
          && request.auth.uid == request.resource.data.userId
          && request.resource.id == request.auth.uid
          && request.resource.data.keys().hasAll(['serviceId','userId','rating'])
          && request.resource.data.serviceId == serviceId
          && isInt(request.resource.data.rating)
          && request.resource.data.rating >= 1 && request.resource.data.rating <= 5
          && (!request.resource.data.keys().hasAny(['comment']) || (request.resource.data.comment is string && request.resource.data.comment.size() <= 5000))
          && request.auth.uid != get(/databases/$(database)/documents/services/$(serviceId)).data.providerId
          && (!request.resource.data.keys().hasAny(['createdAt']) || nearNow(request.resource.data.createdAt))
          && (!request.resource.data.keys().hasAny(['updatedAt']) || nearNow(request.resource.data.updatedAt));

        // Actualizar reseña con whitelisting y re-validación + inmutables
        allow update: if isSignedIn()
          && request.auth.uid == resource.data.userId
          && request.resource.data.serviceId == resource.data.serviceId
          && request.resource.data.userId == resource.data.userId
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating','comment','updatedAt'])
          && isInt(request.resource.data.rating)
          && request.resource.data.rating >= 1 && request.resource.data.rating <= 5
          && (!request.resource.data.keys().hasAny(['comment']) || (request.resource.data.comment is string && request.resource.data.comment.size() <= 5000))
          && (!request.resource.data.keys().hasAny(['updatedAt']) || (
               request.resource.data.updatedAt is timestamp
               && request.resource.data.updatedAt >= resource.data.updatedAt
               && nearNow(request.resource.data.updatedAt)
             ));

        allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
      }

      // Metadatos de imágenes de servicios
      match /images/{imageId} {
        allow read: if true;
        allow write: if isServiceOwner(serviceId);
      }
    }

    // === FAVORITOS ===
    // Usando id canónico ${uid}_${serviceId} para prevenir duplicados
    match /favorites/{favoriteId} {
      // Lectura (temporal: más permisiva para compatibilidad)
      allow read: if isSignedIn() && (
        // Get directo si el documento pertenece al usuario
        favoriteId.matches('.*' + request.auth.uid + '.*') 
        // O si es un list query (mantener restricción where para mejor seguridad)
        || (request.method == 'list' && request.query != null)
      );

      // Crear con id canónico validado para prevenir duplicados
      allow create: if isSignedIn()
        && request.auth.uid == request.resource.data.userId
        && request.resource.id == (request.auth.uid + '_' + request.resource.data.serviceId)
        && request.resource.data.keys().hasOnly(['userId','serviceId','createdAt'])
        && exists(/databases/$(database)/documents/services/$(request.resource.data.serviceId))
        && (!request.resource.data.keys().hasAny(['createdAt']) || nearNow(request.resource.data.createdAt));

      // Solo dueño puede actualizar/eliminar
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }
    
    // === CATEGORÍAS DE SERVICIOS ===
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if false; // Solo administradores
    }
    
    // === CONFIGURACIÓN GLOBAL ===
    match /app_config/{configId} {
      allow read: if true;
      allow write: if false; // Solo administradores
    }
    
    // === UBICACIONES ===
    match /locations/{locationId} {
      allow read: if true;
      allow write: if false; // Solo el sistema
    }
    
    // === REPORTES ===
    match /reports/{reportId} {
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.reporterId;
      allow read, update, delete: if false; // Solo administradores
    }
    
    // Denegar acceso a todo lo demás por defecto
    match /{document=**} {
      allow read, write: if false;
    }
  }
}